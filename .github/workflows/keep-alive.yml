name: Keep Alive3.0

on:
  schedule:
    # æ¯ 4 å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: "0 */4 * * *"
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  wake-space:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install gradio_client requests
      
      # ===== æ–¹æ³• 1: HuggingFace å®˜æ–¹ APIï¼ˆæœ€å¯é ï¼‰=====
      - name: Method 1 - HF Official API
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SPACE_ID: "myleyu/solana-defi-monitor"
        run: |
          echo "========================================"
          echo "ğŸš€ æ–¹æ³• 1: ä½¿ç”¨ HF å®˜æ–¹ API"
          echo "ğŸ“ Space: $SPACE_ID"
          echo "â° æ—¶é—´: $(date)"
          echo "========================================"
          
          # è°ƒç”¨ HuggingFace API è·å– Space ä¿¡æ¯
          API_URL="https://huggingface.co/api/spaces/$SPACE_ID"
          
          echo "ğŸ“¡ è°ƒç”¨ HF API: $API_URL"
          result=$(curl -s -w "\n%{http_code} %{time_total}" \
            -H "Authorization: Bearer $HF_TOKEN" \
            "$API_URL")
          
          http_code=$(echo "$result" | tail -1 | awk '{print $1}')
          time_total=$(echo "$result" | tail -1 | awk '{print $2}')
          
          echo "âœ… HTTP çŠ¶æ€ç : $http_code"
          echo "â±ï¸  å“åº”æ—¶é—´: ${time_total}s"
          
          if [ "$http_code" = "200" ]; then
            echo "ğŸ‰ API è°ƒç”¨æˆåŠŸ - Space å·²è¢«å”¤é†’"
            
            # è§£æ Space çŠ¶æ€
            space_info=$(echo "$result" | head -n -1)
            echo "$space_info" | grep -q "runtime" && echo "âœ… æ£€æµ‹åˆ° runtime ä¿¡æ¯"
            
          else
            echo "âš ï¸ API è¿”å›çŠ¶æ€ç : $http_code"
          fi
          echo ""
        continue-on-error: true
      
      # ===== æ–¹æ³• 2: Gradio Clientï¼ˆå¤‡ç”¨ï¼‰=====
      - name: Method 2 - Gradio Client
        env:
          SPACE_URL: ${{ secrets.SPACE_URL }}
        run: |
          echo "========================================"
          echo "ğŸš€ æ–¹æ³• 2: ä½¿ç”¨ Gradio Client"
          echo "========================================"
          python wake_space.py
        continue-on-error: true
      
      # ===== æ–¹æ³• 3: æµè§ˆå™¨æ¨¡æ‹Ÿï¼ˆç¬¬äºŒå¤‡ç”¨ï¼‰=====
      - name: Method 3 - Browser Simulation
        if: always()
        env:
          SPACE_URL: ${{ secrets.SPACE_URL }}
        run: |
          echo "========================================"
          echo "ğŸš€ æ–¹æ³• 3: æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®"
          echo "========================================"
          python browser_wake.py
        continue-on-error: true
      
      # ===== æ€»ç»“ =====
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "âœ… ä¿æ´»ä»»åŠ¡å®Œæˆ"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ“Š ä½¿ç”¨äº† 3 ç§æ–¹æ³•ç¡®ä¿å”¤é†’"
          echo "ğŸ”„ ä¸‹æ¬¡è¿è¡Œ: 4 å°æ—¶å"
          echo "========================================"
